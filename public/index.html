<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ThreeJs-Demo</title>
    <style>
      body {
        padding: 0;
        margin: 0;
        cursor: move;
      }
    </style>
    <!-- <script src="https://threejs.org/examples/jsm/controls/OrbitControls.js"></script> -->
    <script src="https://threejs.org/build/three.js"></script>
  </head>

  <body>
    <div id="container"></div>
  </body>

  <script type="module">
    import { OrbitControls } from 'https://threejs.org/examples/jsm/controls/OrbitControls.js';
    console.log(OrbitControls)
    function init() {
      var isUserInteracting = false,
        onMouseDownMouseX = 0,
        onMouseDownMouseY = 0,
        lon = 0,
        lat = 0,
        onMouseDownLon = 0,
        onMouseDownLat = 0,
        onPointerDownLat = 0,
        phi = 0,
        theta = 0,
        onPointerDownPointerX = 0,
        onPointerDownPointerY = 0,
        onPointerDownLon = 0

      var mouse = new THREE.Vector2()

      // 摄像机移动参数
      var camera_time = 0
      var interactMeshes = []
      var anchorMeshes = []
      var murderer
      var outsideTextTip

      const container = document.getElementById('container')
      // 添加鼠标
      document.addEventListener('mousedown', onDocumentMouseDown, false)
      document.addEventListener(
        'mouseup',
        () => (isUserInteracting = false),
        false
      )
      document.addEventListener('touchstart', onDocumentTouchDown, false)
      document.addEventListener(
        'touchend',
        () => (isUserInteracting = false),
        false
      )
      document.addEventListener('mousemove', onDocumentMouseMove, false)
      document.addEventListener('touchmove', onDocumentTouchMove, false)
      window.addEventListener('resize', onWindowResize, false)
      window.addEventListener('wheel', onDocumentMouseWheel, false)

      // 创建渲染器，添加抗锯齿
      const renderer = new THREE.WebGLRenderer({ antialias: true })

      // 设置像素比
      renderer.setPixelRatio(window.devicePixelRatio)
      renderer.setSize(window.innerWidth, window.innerHeight)
      renderer.shadowMap.enabled = true

      container.appendChild(renderer.domElement)

      // 创建场景
      const scene = new THREE.Scene()

      // 全景场景
      const geometry = new THREE.SphereGeometry(600, 60, 60)
      // 按z轴翻转
      geometry.scale(1, 1, -1)
      // 添加贴图：全景图
      const skyTexture = new THREE.MeshBasicMaterial({
        map: new THREE.TextureLoader().load('./image/skyTexture_1.jpg'),
      })

      // 渲染贴图
      mesh = new THREE.Mesh(geometry, skyTexture)

      scene.add(mesh)

      // 摄像机
      const camera = new THREE.PerspectiveCamera(
        75,
        window.innerWidth / window.innerHeight,
        1,
        1000
      )
      // 设置摄像机位置
      camera.position.set(0, 0, 0)
      camera.target = new THREE.Vector3(0, 0, 0)

      const controls = new THREE.OrbitControls(camera, renderer.domElement)
      controls.target.set(0, 0, 0)
      controls.enableDamping = true

      // 窗口改变重新渲染
      function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight
        camera.updateProjectionMatrix()
        renderer.setSize(window.innerWidth, window.innerHeight)
      }
      function onDocumentMouseDown(event) {
        isUserInteracting = true
        onPointerDownPointerX = event.clientX
        onPointerDownPointerY = event.clientY
        onPointerDownLon = lon
        onPointerDownLat = lat
      }

      function onDocumentTouchDown(event) {
        isUserInteracting = true
        onPointerDownPointerX = event.touches[0].pageX
        onPointerDownPointerY = event.touches[0].pageY
        onPointerDownLon = lon
        onPointerDownLat = lat
      }

      function onDocumentMouseMove(event) {
        mouse.x = (event.clientX / window.innerWidth) * 2 - 1
        mouse.y = -(event.clientY / window.innerHeight) * 2 + 1
        if (isUserInteracting === true) {
          lon = (onPointerDownPointerX - event.clientX) * 0.1 + onPointerDownLon
          lat = (event.clientY - onPointerDownPointerY) * 0.1 + onPointerDownLat
        }
      }
      function onDocumentTouchMove(event) {
        if (isUserInteracting === true) {
          lon =
            (onPointerDownPointerX - event.touches[0].pageX) * 0.1 +
            onPointerDownLon
          lat =
            (event.touches[0].pageY - onPointerDownPointerY) * 0.1 +
            onPointerDownLat
        }
      }

      function onDocumentMouseWheel(event) {
        camera.fov += event.deltaY * 0.01
        camera.updateProjectionMatrix()
      }

      //捕捉鼠标
      function update() {
        lat = Math.max(-85, Math.min(85, lat))
        phi = THREE.Math.degToRad(90 - lat)
        theta = THREE.Math.degToRad(lon)
        camera.target.x = 500 * Math.sin(phi) * Math.cos(theta)
        camera.target.y = 500 * Math.cos(phi)
        camera.target.z = 500 * Math.sin(phi) * Math.sin(theta)
        camera.lookAt(camera.target)
        if (camera_time > 0 && camera_time < 50) {
          camera.target.x = 0
          camera.target.y = 1
          camera.target.z = 24
          camera.lookAt(camera.target)
          camera.fov -= 1
          camera.updateProjectionMatrix()
          camera_time++
          outsideTextTip.visible = false
        } else if (camera_time === 50) {
          lat = -2
          lon = 182
          camera_time = 0
          camera.fov = 75
          camera.updateProjectionMatrix()
          mesh.material = inside_low
          new THREE.TextureLoader().load(
            './assets/images/inside.jpg',
            function (texture) {
              inside = new THREE.MeshBasicMaterial({
                map: texture,
              })
              mesh.material = inside
            }
          )
          loadMarker('inside')
        }
        renderer.render(scene, camera)
      }

      function animate() {
        requestAnimationFrame(animate)
        // update()
        renderer.render(scene, camera)
        controls && controls.update()
      }
      animate()
    }
    init()
  </script>
</html>
